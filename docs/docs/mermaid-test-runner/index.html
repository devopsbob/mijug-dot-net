<!doctype html> <html lang="en" class="no-js"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta http-equiv="Content-Security-Policy" content=" default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://cdn.jsdelivr.net https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://ep1.adtrafficquality.google https://ep2.adtrafficquality.google https://csi.gstatic.com ; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net ; style-src-elem 'self' 'unsafe-inline' ; img-src 'self' data: https: https://www.google-analytics.com https://pagead2.googlesyndication.com https://ep1.adtrafficquality.google https://ep2.adtrafficquality.google; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com data:; connect-src 'self' https://www.google-analytics.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://ep1.adtrafficquality.google https://ep2.adtrafficquality.google ; frame-src 'self' https://www.google.com https://googleads.g.doubleclick.net https://pagead2.googlesyndication.com https://ep1.adtrafficquality.google https://ep2.adtrafficquality.google ; object-src 'none'; base-uri 'self'; form-action 'self'; manifest-src 'self';block-all-mixed-content;upgrade-insecure-requests"> <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin="anonymous" /> <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous" /> <link rel="preconnect" href="https://www.google-analytics.com" crossorigin="anonymous" /> <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin="anonymous" /> <link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin="anonymous" /> <meta name="google-adsense-account" content="ca-pub-3383458876439157" /> <!-- Critical navigation styles - always inlined for immediate user interaction --> <style> /* Navigation toggle button - ALWAYS VISIBLE */ .nav-toggle { display: flex; align-items: center; justify-content: center; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: #2c5aa0; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; border-radius: 6px; z-index: 101; min-height: 24px; min-width: 24px; } /* Progressive enhancement - hide desktop nav when JS enabled */ html.js nav.primary-nav { display: none; } /* Overlay navigation */ html.js nav.primary-nav.nav-overlay { display: block; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85); z-index: 100; opacity: 0; visibility: hidden; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease; overflow-y: auto; } html.js nav.primary-nav.nav-overlay.nav-visible { opacity: 1; visibility: visible; transform: translateY(0); } /* Body scroll lock when overlay is open */ body.nav-open { overflow: hidden; position: fixed; width: 100%; } /* No-JS fallback */ html.no-js .nav-toggle { display: none; } /* Accessibility - visually hidden elements */ .visually-hidden { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; } /* Performance optimization for font loading */ html { font-display: swap; } /* Reduce layout shift during navigation initialization */ .site-header .wrapper { min-height: 55.95px; } </style> <!-- Preload fonts for better performance --> <link rel="preload" href="/assets/fonts/InterVariable.woff2" as="font" type="font/woff2" crossorigin="anonymous" immutable /> <link rel="preconnect" href="https://fonts.googleapis.com" /> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> <!-- Critical CSS for above-the-fold content --> <style> /** * Critical path CSS for above-the-fold content * Optimized for < 12s build target and initial viewport rendering */ /* Base variables for theming */ :root { --bg-color: #ffffff; --text-color: #222222; --accent-color: #1e8449; /* WCAG AA compliant green */ --link-color: #0066cc; --nav-bg: #f8f8f8; --border-color: #e8e8e8; --header-color: #424242; --focus-outline: 2px solid #1e8449; --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; --font-size-base: 16px; --line-height-base: 1.5; } /* Base element styles */ html { font-size: var(--font-size-base); font-family: var(--font-family-base); line-height: var(--line-height-base); -webkit-text-size-adjust: 100%; text-size-adjust: 100%; } body { margin: 0; padding: 0; color: var(--text-color); background-color: var(--bg-color); min-height: 100vh; display: flex; flex-direction: column; } /* Wrapper for content layout */ .wrapper { max-width: 960px; margin: 0 auto; padding: 0 15px; width: calc(100% - 30px); } /* Critical header and navigation styles */ .site-header { border-bottom: 1px solid var(--border-color); min-height: 56px; background-color: var(--nav-bg); position: relative; display: flex; align-items: center; } .site-header .wrapper { display: flex; justify-content: space-between; align-items: center; width: 100%; } .site-title { font-size: 1.5rem; font-weight: 300; letter-spacing: -1px; margin-bottom: 0; color: var(--header-color); text-decoration: none; display: flex; align-items: center; line-height: 56px; } .site-title img { margin-right: 10px; width: 50px; height: 50px; } .site-title.long-title { font-size: 1.25rem; } /* Navigation styling */ .site-nav { position: relative; line-height: 56px; } .site-nav .nav-trigger { display: none; } .site-nav .menu-icon { display: none; } .site-nav .page-link { color: var(--text-color); line-height: 1.5; text-decoration: none; margin-right: 20px; } .site-nav .page-link:hover { color: var(--accent-color); } .nav-button { background-color: var(--accent-color); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-family: var(--font-family-base); font-size: 0.875rem; font-weight: 500; line-height: 1.2; } /* Main content area */ .page-content { padding: 30px 0; flex: 1; } /* Skip link - accessibility feature */ .skip-to-content { position: absolute; top: -50px; left: 10px; background: var(--accent-color); color: white; padding: 8px; z-index: 100; transition: top 0.3s ease; } .skip-to-content:focus { top: 10px; } /* Focus outline for accessibility */ :focus { outline: var(--focus-outline); outline-offset: 2px; } /* Basic media query for responsive design */ @media screen and (max-width: 600px) { .site-nav { position: absolute; top: 9px; right: 15px; background-color: var(--nav-bg); border: 1px solid var(--border-color); border-radius: 5px; text-align: right; z-index: 10; } .site-nav .menu-icon { display: block; float: right; width: 36px; height: 26px; line-height: 0; padding-top: 10px; text-align: center; cursor: pointer; } .site-nav .menu-icon > svg { width: 18px; height: 15px; } .site-nav .trigger { clear: both; display: none; padding-bottom: 5px; } .site-nav:not([popover]) .nav-trigger:checked ~ .trigger { display: block; } .site-nav .page-link { display: block; padding: 5px 10px; margin: 0; } } /* SR-only class for accessibility */ .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; } /* Basic typography for content */ h1, h2, h3, h4, h5, h6 { margin-top: 0; color: var(--header-color); } h1 { font-size: 2rem; margin-bottom: 0.5em; } p { margin-top: 0; margin-bottom: 1em; } /* SVG icon in header */ .svg-icon { width: 16px; height: 16px; display: inline-block; fill: currentColor; vertical-align: text-bottom; flex-shrink: 0; box-sizing: content-box; } /* Image aspect ratio and container styles */ img { aspect-ratio: attr(width) / attr(height); } .image-container { position: relative; height: 0; overflow: hidden; } .image-container--16-9 { padding-bottom: 56.25%; /* 16:9 aspect ratio */ } .image-container--4-3 { padding-bottom: 75%; /* 4:3 aspect ratio */ } .image-container img { position: absolute; width: 100%; height: 100%; object-fit: cover; } /* Cookie consent banner styles */ #cookie-consent-banner { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; max-height: 0; opacity: 0; transform: translateY(100%); transition: transform 0.3s, opacity 0.3s, max-height 0s 0.3s; overflow: hidden; } #cookie-consent-banner.visible { max-height: 200px; opacity: 1; transform: translateY(0); transition: transform 0.3s, opacity 0.3s; } /* Advertisement container styles */ .ad-container { min-height: 250px; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9; margin: 1rem 0; overflow: hidden; contain: layout size; } .ad-container::before { content: "Advertisement"; color: #777; font-size: 0.75rem; position: absolute; top: 5px; right: 5px; } /* Mermaid diagram container styles */ .mermaid-container { position: relative; width: 100%; min-height: 150px; margin: 1.5rem 0; background-color: rgba(0,0,0,0.03); border-radius: 4px; overflow: hidden; contain: layout style paint; } .mermaid-container::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent 25%, rgba(255,255,255,.5) 50%, transparent 75%) -200% 0 / 400% 100%, linear-gradient(rgba(0,0,0,.1) 0%, transparent 20%, transparent 80%, rgba(0,0,0,.1) 100%); animation: loading 1.5s infinite linear; opacity: 0.5; } @keyframes loading { to { background-position: 100% 0, 0 0; } } [popover] { contain: layout size; } .site-nav[popover] { /* Pre-compute layout position */ position: absolute; top: 9px; right: 15px; z-index: 100; /* Prevent layout shift during animations */ transform: translateZ(0); will-change: transform; } </style> <link rel="preload" href="/assets/main.css" as="style" onload="this.onload=null;this.rel='stylesheet'"> <noscript><link rel="stylesheet" href="/assets/main.css"></noscript> <title> Mermaid Test Runner | My Information Just Under Glass </title> <meta name="description" content="This document describes the dedicated test runner for Mermaid diagram functionality in the MIJUG .NET workspace." /> <meta name="version" content="Sep 02, 2025" /> <meta name="docs-nav-order" content="18" /> <meta name="docs-section" content="documentation" /> <meta name="priority-doc" content="true" /> <meta name="google-site-verification" content="googlece83719b3f856e56" /> <meta name="cache-version" content="20250926013331" /> <link rel="preload" as="style" href="/assets/main.css?v=20250927034911" media="print" crossorigin><link rel="stylesheet" href="/assets/main.css?v=20250927034911" media="print"> <link rel="preload" as="style" href="/assets/css/inp-optimizations.css?v=20250927034911" media="print" crossorigin><link rel="stylesheet" href="/assets/css/inp-optimizations.css?v=20250927034911" media="print"> <noscript> <link rel="stylesheet" href="/assets/main.css?v=20250927034911"> <link rel="stylesheet" href="/assets/css/inp-optimizations.css?v=20250927034911"> </noscript> <link rel="alternate" type="application/rss+xml" title="My Information Just Under Glass" href="/feed.xml" /> <link rel="icon" type="image/svg+xml" href="/assets/logo-mijug-96x96.png?v=20250926013331" /> <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /> <link rel="manifest" href="/manifest.webmanifest" /> <meta name="description" content="Dedicated test runner for Mermaid diagram functionality with multi-browser support and comprehensive testing options" /> <meta property="og:title" content="Mermaid Test Runner" /> <meta property="og:description" content="Dedicated test runner for Mermaid diagram functionality with multi-browser support and comprehensive testing options" /> <meta property="og:url" content="https://www.mijug.net/docs/mermaid-test-runner/" /> <meta property="og:site_name" content="My Information Just Under Glass" /> <meta property="og:type" content="website" /><meta property="og:image" content="https://www.mijug.net/assets/logo-mijug-96x96.png" /><link rel="canonical" href="https://www.mijug.net/docs/mermaid-test-runner/" /> <script> window.MIJUG = window.MIJUG || {}; window.MIJUG.cacheVersion = "20250926013331"; </script> <script> window.print = function () { console.log('Skip printing'); }; window.addEventListener('keydown', function(event) { if (event.keyCode === 80 && (event.ctrlKey || event.metaKey) && !event.altKey && (!event.shiftKey || window.chrome || window.opera)) { event.preventDefault(); if (event.stopImmediatePropagation) { event.stopImmediatePropagation(); } else { event.stopPropagation(); } return; } if (event.ctrlKey && (event.key === "p" || event.key === "s")) { event.preventDefault(); } }, true); </script> </head> <body oncontextmenu="return false;"> <header class="site-header" role="banner"> <div class="wrapper"> <a class="site-title long-title" rel="home" href="/"> <img src="/assets/logo-mijug-96x96.png?v=20250926013331" alt="My Information Just Under Glass" width="50" height="50"> My Information Just Under Glass </a> <button class="nav-toggle" aria-controls="primary-navigation" aria-expanded="false" aria-label="Toggle navigation menu"> Menu </button> <nav id="primary-navigation" class="primary-nav" role="navigation" aria-label="Main navigation"> <ul> <li> <a href="/blog/" aria-label="Navigate to Blog"> Blog </a> </li> <li> <a href="/about/" aria-label="Navigate to About"> About </a> </li> <li> <a href="/docs/getting-started/" aria-label="Navigate to Getting Started"> Getting Started </a> </li> <li> <a href="/docs/welcome-mijug-workspace/" aria-label="Navigate to Workspace Overview"> Workspace Overview </a> </li> <li> <a href="/docs/frontmatter-cms/" aria-label="Navigate to FrontMatter CMS Usage"> FrontMatter CMS Usage </a> </li> <li> <a href="/docs/accessibility-testing/" aria-label="Navigate to Accessibility Testing Configuration"> Accessibility Testing Configuration </a> </li> <li> <a href="/docs/browser-management/" aria-label="Navigate to Browser Management for Testing"> Browser Management for Testing </a> </li> <li> <a href="/docs/browser-compatibility-testing/" aria-label="Navigate to Browser Compatibility Testing"> Browser Compatibility Testing </a> </li> <li> <a href="/docs/liquid-tags-examples/" aria-label="Navigate to Liquid Tags Examples"> Liquid Tags Examples </a> </li> <li> <a href="/docs/tags-and-categories-guide/" aria-label="Navigate to Tags and Categories System Guide"> Tags and Categories System Guide </a> </li> <li> <a href="/docs/performance-optimization/" aria-label="Navigate to Performance Optimization Guide"> Performance Optimization Guide </a> </li> <li> <a href="/docs/testing-performance-evolution/" aria-label="Navigate to Testing Performance and Development Evolution"> Testing Performance and Development Evolution </a> </li> <li> <a href="/docs/cache-management/" aria-label="Navigate to Cache Management Strategies"> Cache Management Strategies </a> </li> <li> <a href="/docs/mermaid-configuration-guide/" aria-label="Navigate to Mermaid Diagram Configuration Guide"> Mermaid Diagram Configuration Guide </a> </li> <li> <a href="/docs/mermaid-quick-start/" aria-label="Navigate to Mermaid Quick Start"> Mermaid Quick Start </a> </li> <li> <a href="/docs/mermaid-examples/" aria-label="Navigate to Mermaid Diagram Examples"> Mermaid Diagram Examples </a> </li> <li> <a href="/docs/mermaid-diagrams-sample/" aria-label="Navigate to Mermaid Diagrams Sample"> Mermaid Diagrams Sample </a> </li> <li> <a href="/docs/mermaid-test-runner/" aria-label="Navigate to Mermaid Diagrams Test Runner"> Mermaid Diagrams Test Runner </a> </li> <li> <a href="/docs/rel-attribute-guide/" aria-label="Navigate to The rel Attribute in HTML Links: A Comprehensive Guide"> The rel Attribute in HTML Links: A Comprehensive Guide </a> </li> <li> <a href="/docs/exploring-limitations-of-gitea-and-ruby/" aria-label="Navigate to Exploring the Limitations of Gitea and Ruby"> Exploring the Limitations of Gitea and Ruby </a> </li> </ul> </nav> <div id="menu-status" class="visually-hidden" role="status" aria-live="polite"></div> </div> </header> <main class="page-content" aria-label="Content"> <div class="wrapper">
<article class="post"> <header class="post-header"> <h1 class="post-title">Mermaid Test Runner</h1> </header> <div class="post-content">
<p>This document describes the dedicated test runner for Mermaid diagram functionality in the MIJUG .NET workspace.</p> <h2 id="overview">Overview</h2> <p>The <code class="language-plaintext highlighter-rouge">scripts/test-mermaid-diagrams.js</code> script provides a specialized test runner that focuses exclusively on Mermaid diagram rendering and functionality. It automatically discovers all mermaid-related test files and provides flexible browser testing options.</p> <h2 id="features">Features</h2> <ul> <li>
<strong>Automatic Test Discovery</strong>: Finds all mermaid-related test files in the e2e directory</li> <li>
<strong>Multi-Browser Support</strong>: Tests with Chromium, Firefox, and WebKit</li> <li>
<strong>Browser Management</strong>: Automatic browser installation and verification</li> <li>
<strong>Flexible Options</strong>: Headed/headless modes, debug mode, custom worker counts</li> <li>
<strong>Error Handling</strong>: Robust error handling with helpful messages</li> <li>
<strong>Cross-Platform</strong>: Works on Linux, macOS, and Windows</li> </ul> <h2 id="usage">Usage</h2> <h3 id="basic-commands">Basic Commands</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run all mermaid tests with default settings (Chromium, headless)</span>
npm run <span class="nb">test</span>:mermaid

<span class="c"># Run with browser UI visible (helpful for debugging)</span>
npm run <span class="nb">test</span>:mermaid:headed

<span class="c"># Run in debug mode (step-by-step execution)</span>
npm run <span class="nb">test</span>:mermaid:debug

<span class="c"># Run with Firefox browser</span>
npm run <span class="nb">test</span>:mermaid:firefox
</code></pre></div></div> <h3 id="advanced-options">Advanced Options</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run with specific browser and options</span>
node scripts/test-mermaid-diagrams.js <span class="nt">--project</span><span class="o">=</span>webkit <span class="nt">--workers</span><span class="o">=</span>2 <span class="nt">--verbose</span>

<span class="c"># Ensure browsers are installed first</span>
node scripts/test-mermaid-diagrams.js <span class="nt">--ensure-browsers</span>

<span class="c"># Run in headed mode with debug</span>
node scripts/test-mermaid-diagrams.js <span class="nt">--headed</span> <span class="nt">--debug</span>

<span class="c"># Get help and see all available options</span>
node scripts/test-mermaid-diagrams.js <span class="nt">--help</span>
</code></pre></div></div> <h2 id="command-line-options">Command Line Options</h2> <table> <thead> <tr> <th>Option</th> <th>Description</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">--ensure-browsers</code></td> <td>Install browsers before testing</td> <td><code class="language-plaintext highlighter-rouge">--ensure-browsers</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">--headed</code></td> <td>Run with browser UI visible</td> <td><code class="language-plaintext highlighter-rouge">--headed</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">--debug</code></td> <td>Step-by-step debug mode</td> <td><code class="language-plaintext highlighter-rouge">--debug</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">--project=&lt;name&gt;</code></td> <td>Specify browser (chromium, firefox, webkit)</td> <td><code class="language-plaintext highlighter-rouge">--project=firefox</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">--workers=&lt;num&gt;</code></td> <td>Number of parallel workers (default: 1)</td> <td><code class="language-plaintext highlighter-rouge">--workers=2</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">--verbose</code></td> <td>Enable verbose output</td> <td><code class="language-plaintext highlighter-rouge">--verbose</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">--help</code></td> <td>Show help message</td> <td><code class="language-plaintext highlighter-rouge">--help</code></td> </tr> </tbody> </table> <h2 id="test-files-covered">Test Files Covered</h2> <p>The script automatically discovers and runs these test files:</p> <ol> <li>
<strong><code class="language-plaintext highlighter-rouge">e2e/mermaid-basic-visual.spec.ts</code></strong> <ul> <li>Tests basic mermaid diagram rendering</li> <li>Validates SVG generation and visual elements</li> </ul> </li> <li>
<strong><code class="language-plaintext highlighter-rouge">e2e/mermaid-default-layout.spec.ts</code></strong> <ul> <li>Tests mermaid rendering in default page layout</li> <li>Validates sequence diagrams and syntax error handling</li> </ul> </li> <li>
<strong><code class="language-plaintext highlighter-rouge">e2e/mermaid-diagrams-visual.spec.ts</code></strong> <ul> <li>Tests visual diagram sample page</li> <li>Validates multiple diagram types and SVG content</li> </ul> </li> <li>
<strong><code class="language-plaintext highlighter-rouge">e2e/mermaid-documentation.spec.ts</code></strong> <ul> <li>Tests documentation pages</li> <li>Validates quick start, configuration guide, and examples</li> </ul> </li> </ol> <h2 id="browser-compatibility">Browser Compatibility</h2> <table> <thead> <tr> <th>Browser</th> <th>Support Level</th> <th>Notes</th> </tr> </thead> <tbody> <tr> <td><strong>Chromium</strong></td> <td>✅ Full</td> <td>Default browser, fastest execution</td> </tr> <tr> <td><strong>Firefox</strong></td> <td>✅ Full</td> <td>Good compatibility, slightly slower</td> </tr> <tr> <td><strong>WebKit</strong></td> <td>✅ Full</td> <td>Safari engine, best for macOS testing</td> </tr> </tbody> </table> <h2 id="error-handling">Error Handling</h2> <p>The script provides comprehensive error handling:</p> <ul> <li>
<strong>Browser Detection</strong>: Automatically detects available browsers</li> <li>
<strong>Fallback Support</strong>: Falls back to available browsers if requested browser isn’t available</li> <li>
<strong>Installation Help</strong>: Guides users to install missing browsers</li> <li>
<strong>Clear Messages</strong>: Provides helpful error messages and suggestions</li> </ul> <h2 id="integration-with-cicd">Integration with CI/CD</h2> <p>The script is designed to work in continuous integration environments:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example GitHub Actions usage</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Mermaid Tests</span>
  <span class="na">run</span><span class="pi">:</span> <span class="s">npm run test:mermaid</span>

<span class="c1"># With specific browser</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Mermaid Tests (Firefox)</span>
  <span class="na">run</span><span class="pi">:</span> <span class="s">npm run test:mermaid:firefox</span>

<span class="c1"># With browser installation</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Mermaid Tests (All Browsers)</span>
  <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">npm run test:mermaid -- --ensure-browsers --project=chromium</span>
    <span class="s">npm run test:mermaid -- --project=firefox</span>
    <span class="s">npm run test:mermaid -- --project=webkit</span>
</code></pre></div></div> <h2 id="performance-considerations">Performance Considerations</h2> <ul> <li>
<strong>Single Worker Default</strong>: Uses 1 worker by default for stability</li> <li>
<strong>Network Idle</strong>: Waits for network idle state before testing</li> <li>
<strong>Timeout Handling</strong>: Includes appropriate timeouts for browser operations</li> <li>
<strong>Resource Cleanup</strong>: Properly cleans up browser instances</li> </ul> <h2 id="debugging">Debugging</h2> <p>For debugging mermaid rendering issues:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run in debug mode with browser UI</span>
npm run <span class="nb">test</span>:mermaid:debug

<span class="c"># Run specific test file in headed mode</span>
node scripts/test-mermaid-diagrams.js <span class="nt">--headed</span> <span class="nt">--project</span><span class="o">=</span>chromium e2e/mermaid-basic-visual.spec.ts

<span class="c"># Enable verbose output for detailed logs</span>
node scripts/test-mermaid-diagrams.js <span class="nt">--verbose</span> <span class="nt">--headed</span>
</code></pre></div></div> <h2 id="configuration">Configuration</h2> <p>The script respects the Playwright configuration in <code class="language-plaintext highlighter-rouge">playwright.config.ts</code> but allows overrides via command line arguments.</p> <h2 id="output-example">Output Example</h2> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>🎨 Mermaid Diagrams Test Runner Starting...
ℹ️  🔧 Ensuring browsers are installed...
✅ All browsers are ready for testing!
ℹ️  📊 Browser Engine Summary:
ℹ️    🎯 (selected) chromium - Available
ℹ️    ✅ firefox - Available
ℹ️    ✅ webkit - Available
ℹ️  🚀 Starting Mermaid diagram tests...
ℹ️  Found 4 mermaid test files:
🔍   - e2e/mermaid-basic-visual.spec.ts
🔍   - e2e/mermaid-default-layout.spec.ts
🔍   - e2e/mermaid-diagrams-visual.spec.ts
🔍   - e2e/mermaid-documentation.spec.ts

Running 7 tests using 1 worker
  ✓  All tests passed
✅ ✅ All Mermaid tests completed successfully!
</code></pre></div></div> <h2 id="troubleshooting">Troubleshooting</h2> <h3 id="common-issues">Common Issues</h3> <ol> <li> <p><strong>Browser Not Found</strong></p> <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># Solution: Install browsers</span>
npm run <span class="nb">test</span>:mermaid <span class="nt">--</span> <span class="nt">--ensure-browsers</span>
</code></pre></div> </div> </li> <li> <p><strong>Permission Errors</strong></p> <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># Solution: Run with proper permissions or use skipIfNoPermissions</span>
node scripts/test-mermaid-diagrams.js <span class="nt">--ensure-browsers</span> <span class="nt">--skip-if-no-permissions</span>
</code></pre></div> </div> </li> <li> <p><strong>Network Timeouts</strong></p> <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># Solution: Increase timeout or check network connectivity</span>
node scripts/test-mermaid-diagrams.js <span class="nt">--workers</span><span class="o">=</span>1
</code></pre></div> </div> </li> <li> <p><strong>iNotify Watches Limit Exceeded (Linux)</strong></p> <p><strong>Error</strong>: <code class="language-plaintext highlighter-rouge">Listen::Error::INotifyMaxWatchesExceeded: Unable to monitor directories for changes because iNotify max watches exceeded</code></p> <p><strong>Symptoms</strong>: Jekyll server fails to start with file watching errors, preventing the test server from running.</p> <p><strong>Solution</strong>: Increase the iNotify watches limit on Linux systems:</p> <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># Check current limit</span>
<span class="nb">cat</span> /proc/sys/fs/inotify/max_user_watches

<span class="c"># Increase limit permanently (requires sudo)</span>
<span class="nb">echo </span>fs.inotify.max_user_watches<span class="o">=</span>524288 | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">sudo </span>sysctl <span class="nt">-p</span>

<span class="c"># Verify the change</span>
<span class="nb">cat</span> /proc/sys/fs/inotify/max_user_watches
</code></pre></div> </div> <p><strong>Alternative temporary fix</strong>:</p> <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># Temporary increase (until reboot)</span>
<span class="nb">sudo </span>sysctl fs.inotify.max_user_watches<span class="o">=</span>524288
</code></pre></div> </div> <p><strong>Background</strong>: This issue occurs when Jekyll tries to watch too many files for changes. The default Linux limit is typically 8,192 watches, but large projects with many files can exceed this limit. Setting it to 524,288 provides ample headroom for most development scenarios.</p> </li> </ol> <h2 id="future-enhancements">Future Enhancements</h2> <p>Potential improvements to the script:</p> <ul> <li>
<strong>Parallel Browser Testing</strong>: Run multiple browsers simultaneously</li> <li>
<strong>Visual Regression Testing</strong>: Screenshot comparison for diagram rendering</li> <li>
<strong>Performance Metrics</strong>: Measure diagram rendering performance</li> <li>
<strong>Custom Test Patterns</strong>: Allow custom glob patterns for test discovery</li> <li>
<strong>Report Generation</strong>: Generate detailed HTML reports</li> <li>
<strong>Integration Testing</strong>: Test mermaid with different Jekyll configurations</li> </ul> <h2 id="related-documentation">Related Documentation</h2> <ul> <li><a href="/docs/mermaid-configuration-guide/">Mermaid Configuration Guide</a></li> <li><a href="/docs/mermaid-quick-start/">Mermaid Quick Start</a></li> <li><a href="/docs/mermaid-examples/">Mermaid Examples</a></li> <li><a href="https://github.com/devopsbob/mijug-dot-net-project/blob/main/playwright.config.ts" rel="external noopener noreferrer" target="_blank">Playwright Configuration</a></li> <li><a href="https://github.com/devopsbob/mijug-dot-net-project/blob/main/scripts/test-runner.js" rel="external noopener noreferrer" target="_blank">Main Test Runner</a></li> </ul> </div> </article> </div> <div class="ad-container" id="ad-slot-1" data-ad-slot="12345678"></div> </main> <footer class="site-footer h-card"> <data class="u-url" href="/"></data> <div class="wrapper"> <div class="footer-col-wrapper"> <div class="footer-col footer-col-1"> <a href="/terms-of-service.html">Terms of Service</a><br> <a href="/privacy-policy.html">Privacy Policy</a> </div> <div class="footer-col footer-col-2"> <a href="/contact/">Contact Us</a> </div> <div class="footer-col footer-col-3"> <p> © 2025 <a rel="external nofollow" href="https://share.google/8Ir6br641K4uU74l2">Kranson Enterprises</a><br>     subscribe <a href="/feed.xml">via RSS<svg class="svg-icon"> <use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg></a> </p> </div> </div> </div> </footer> <script src="/assets/js/print-helper-optimized.js?v=20250927034911" defer crossorigin="anonymous"></script> <script src="/assets/js/storage-access.js?v=20250927034911" defer crossorigin="anonymous"></script> <script src="/assets/js/accessibility-enhancements.js?v=20250927034911" defer crossorigin="anonymous"></script> <script> function hideCookieConsentBanner() { const banner = document.getElementById('cookie-consent-banner'); if (!banner) return; if (banner.contains(document.activeElement)) { if (document.body) { document.body.focus(); } } banner.setAttribute('inert', ''); banner.style.display = 'none'; } document.addEventListener('DOMContentLoaded', function() { const acceptBtn = document.getElementById('accept-cookies'); if (acceptBtn) { acceptBtn.addEventListener('click', hideCookieConsentBanner); } }); </script> <script> (function() { 'use strict'; var html = document.documentElement; html.className = html.className.replace("no-js", "js"); var toggleBtn = document.querySelector('.nav-toggle'); var nav = document.getElementById('primary-navigation'); var statusEl = document.getElementById('menu-status'); var body = document.body; if (!toggleBtn || !nav || !statusEl) { console.warn('Navigation elements not found - falling back to no-JS behavior'); return; } nav.classList.add('nav-overlay'); function toggleNavigation() { var isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true'; if (isExpanded) { nav.classList.remove('nav-visible'); toggleBtn.setAttribute('aria-expanded', 'false'); nav.setAttribute('aria-hidden', 'true'); toggleBtn.textContent = 'Menu'; statusEl.textContent = 'Menu closed'; body.classList.remove('nav-open'); } else { nav.classList.add('nav-visible'); toggleBtn.setAttribute('aria-expanded', 'true'); nav.removeAttribute('aria-hidden'); toggleBtn.textContent = 'Close'; statusEl.textContent = 'Menu opened'; body.classList.add('nav-open'); } } toggleBtn.addEventListener('click', function(e) { e.preventDefault(); toggleNavigation(); }); document.addEventListener('click', function(e) { if (toggleBtn.getAttribute('aria-expanded') !== 'true') return; if ((!nav.contains(e.target) && !toggleBtn.contains(e.target)) || (e.target.tagName === 'A' && nav.contains(e.target))) { toggleNavigation(); } }); document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && toggleBtn.getAttribute('aria-expanded') === 'true') { toggleNavigation(); toggleBtn.focus(); } }); nav.setAttribute('aria-hidden', 'true'); })(); </script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('consent', 'default', { analytics_storage: 'denied', ad_storage: 'denied', ad_user_data: 'denied', ad_personalization: 'denied', }); gtag('js', new Date()); gtag('config', 'G-W1M1N0DCD4'); </script> <script src="https://www.googletagmanager.com/gtag/js?id=G-W1M1N0DCD4" crossorigin="anonymous" async></script> <!-- Google AdSense with MIJUG Cookie Consent Integration --> <script> // Privacy and consent checks if (window.doNotTrack === '1' || navigator.doNotTrack === '1' || navigator.doNotTrack === 'yes' || navigator.msDoNotTrack === '1' || localStorage.getItem('mijug-ads-disabled') === 'true') { return; } // Development environment bypass if (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:') { console.log('[MIJUG AdSense] Skipped - Development environment'); return; } // URL parameter bypass for testing const urlParams = new URLSearchParams(window.location.search); if (urlParams.get('skip-ads') === 'true') { console.log('[MIJUG AdSense] Skipped - URL parameter override'); return; } // Initialize consent mode with MIJUG defaults window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } window.gtag = gtag; // Set default consent state (MIJUG privacy-first approach) gtag('consent', 'default', { ad_storage: 'denied', ad_user_data: 'denied', ad_personalization: 'denied', analytics_storage: 'denied' }); // Load AdSense with error handling function loadAdSense() { try { const script = document.createElement('script'); script.async = true; script.crossOrigin = 'anonymous'; script.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client='; script.onerror = function() { console.warn('[MIJUG AdSense] Failed to load AdSense script'); }; document.head.appendChild(script); console.log('[MIJUG AdSense] AdSense script loaded'); } catch (error) { console.warn('[MIJUG AdSense] Initialization error:', error); } } // MIJUG cookie consent integration if (typeof window.MijugCookieConsent !== 'undefined') { window.MijugCookieConsent.onReady(function(consent) { if (consent.advertising) { // Update consent for AdSense gtag('consent', 'update', { ad_storage: 'granted', ad_user_data: 'granted', ad_personalization: consent.personalization ? 'granted' : 'denied' }); loadAdSense(); } else { console.log('[MIJUG AdSense] Skipped - Advertising cookies declined'); } }); // Handle consent changes window.MijugCookieConsent.onConsentChange(function(consent) { gtag('consent', 'update', { ad_storage: consent.advertising ? 'granted' : 'denied', ad_user_data: consent.advertising ? 'granted' : 'denied', ad_personalization: (consent.advertising && consent.personalization) ? 'granted' : 'denied' }); }); } else { // Fallback: Load with denied consent if no cookie system console.log('[MIJUG AdSense] Loading with default denied consent - no cookie system detected'); loadAdSense(); } </script> <!-- Cookie Consent Banner for GDPR Compliance --> <div id="cookie-consent-banner" class="cookie-consent-banner" role="complementary" aria-label="Cookie consent banner" aria-live="polite" style="display: none"> <div class="cookie-consent-content"> <div class="cookie-consent-text"> <p> <strong>🍪 Cookie Notice</strong><br> This website uses cookies for Google AdSense and analytics to improve your experience. <a href="/privacy-policy.html" class="cookie-policy-link">Learn more in our Privacy Policy</a> </p> </div> <div class="cookie-consent-buttons"> <button id="accept-cookies" class="cookie-btn cookie-btn-accept" onclick="acceptCookies()"> Accept All Cookies </button> <button id="decline-cookies" class="cookie-btn cookie-btn-decline" onclick="declineCookies()"> Decline Optional Cookies </button> <button id="cookie-settings" class="cookie-btn cookie-btn-settings" onclick="showCookieSettings()"> Cookie Settings </button> </div> </div> </div> <!-- Cookie Settings Modal - Using MIJUG Theme Pattern --> <div id="cookie-settings-modal" class="cookie-modal" style="display: none" role="dialog" aria-modal="true" aria-labelledby="cookie-settings-title"> <div class="cookie-modal-content mijug-highlight"> <div class="cookie-modal-header"> <h3 id="cookie-settings-title">Cookie Settings</h3> <button class="cookie-modal-close" onclick="closeCookieSettings()" aria-label="Close cookie settings dialog"> × </button> </div> <div class="cookie-modal-body"> <p class="cookie-modal-description"> Customize your cookie preferences. Essential cookies are required for basic site functionality and cannot be disabled. </p> <div class="cookie-category"> <div class="cookie-category-header"> <h4>Essential Cookies</h4> <label class="cookie-toggle" for="essential-cookies" aria-label="Essential cookies (required)"> <input type="checkbox" id="essential-cookies" checked disabled> <span class="cookie-slider cookie-slider-disabled"></span> </label> </div> <p class="cookie-category-description">Required for basic site functionality. These cannot be disabled.</p> </div> <div class="cookie-category"> <div class="cookie-category-header"> <h4>Analytics Cookies</h4> <label class="cookie-toggle" for="analytics-cookies" aria-label="Analytics cookies (optional)"> <input type="checkbox" id="analytics-cookies"> <span class="cookie-slider"></span> </label> </div> <p class="cookie-category-description"> Help us understand how visitors interact with our website via Google Analytics. No personally identifiable information is collected. </p> </div> <div class="cookie-category"> <div class="cookie-category-header"> <h4>Advertising Cookies</h4> <label class="cookie-toggle" for="advertising-cookies" aria-label="Advertising cookies (optional)"> <input type="checkbox" id="advertising-cookies"> <span class="cookie-slider"></span> </label> </div> <p class="cookie-category-description"> Used by Google AdSense to display relevant advertisements. Helps support the website through ad revenue. </p> </div> </div> <div class="cookie-modal-footer"> <button class="cookie-btn cookie-btn-accept" onclick="savePreferences()"> Save Preferences </button> <button class="cookie-btn cookie-btn-settings" onclick="closeCookieSettings()"> Cancel </button> </div> </div> </div> <style> html body #cookie-consent-banner.cookie-consent-banner, html body div#cookie-consent-banner.cookie-consent-banner { position: fixed !important; bottom: 0 !important; left: 0 !important; right: 0 !important; background: #2c3e50 !important; color: white !important; padding: 1rem !important; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3) !important; z-index: 2147483647 !important; border-top: 3px solid #3498db !important; display: none !important; visibility: visible !important; opacity: 1 !important; width: 100% !important; min-height: 80px !important; box-sizing: border-box !important; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important; font-size: 14px !important; line-height: 1.4 !important; transform: translateZ(0) !important; will-change: transform !important; } /* Enhanced visibility for all child elements */ html body #cookie-consent-banner.cookie-consent-banner *, html body div#cookie-consent-banner.cookie-consent-banner * { visibility: visible !important; opacity: inherit !important; display: initial !important; } /* Content layout with enhanced specificity */ html body .cookie-consent-content { max-width: 1200px !important; margin: 0 auto !important; display: flex !important; align-items: center !important; justify-content: space-between !important; gap: 1rem !important; flex-wrap: wrap !important; } html body .cookie-consent-text { flex: 1 !important; min-width: 200px !important; } html body .cookie-consent-text p { margin: 0 !important; font-size: 0.9rem !important; line-height: 1.4 !important; color: white !important; } html body .cookie-policy-link { color: #74c0fc !important; text-decoration: underline !important; } html body .cookie-policy-link:hover { color: #a3d5ff !important; } html body .cookie-consent-buttons { display: flex !important; gap: 0.5rem !important; flex-wrap: wrap !important; min-width: 200px !important; } html body .cookie-btn { padding: 0.5rem 1rem !important; border: none !important; border-radius: 4px !important; cursor: pointer !important; font-size: 0.85rem !important; font-weight: 500 !important; transition: all 0.2s ease !important; white-space: nowrap !important; min-width: 80px !important; } html body .cookie-btn-accept { background: #1e8449 !important; color: white !important; } html body .cookie-btn-accept:hover { background: #196f3d !important; } html body .cookie-btn-decline { background: #c0392b !important; color: white !important; } html body .cookie-btn-decline:hover { background: #a93226 !important; } html body .cookie-btn-settings { background: #5d6d7e !important; color: white !important; } html body .cookie-btn-settings:hover { background: #515a5a !important; } /* Modal with enhanced specificity - hidden by default */ html body .cookie-modal { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.7) !important; z-index: 2147483646 !important; display: none !important; align-items: center !important; justify-content: center !important; backdrop-filter: blur(2px) !important; -webkit-backdrop-filter: blur(2px) !important; } html body .cookie-modal-content { background: white !important; border-radius: 8px !important; padding: 2rem !important; max-width: 500px !important; width: 90% !important; max-height: 80vh !important; overflow-y: auto !important; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important; } /* Responsive design with enhanced breakpoints */ @media (max-width: 768px) { html body .cookie-consent-content { flex-direction: column !important; align-items: stretch !important; gap: 0.75rem !important; } html body .cookie-consent-buttons { justify-content: center !important; gap: 0.25rem !important; } html body .cookie-btn { flex: 1 !important; min-width: 0 !important; font-size: 0.8rem !important; padding: 0.4rem 0.8rem !important; } html body .cookie-modal-content { margin: 1rem !important; padding: 1.5rem !important; } } @media (max-width: 480px) { html body .cookie-consent-buttons { flex-direction: column !important; } html body .cookie-btn { width: 100% !important; } } /* Print media - hide banner */ @media print { html body #cookie-consent-banner.cookie-consent-banner, html body .cookie-modal { display: none !important; } } /* High contrast mode support */ @media (prefers-contrast: high) { html body #cookie-consent-banner.cookie-consent-banner { border: 2px solid white !important; } } /* Reduced motion support */ @media (prefers-reduced-motion: reduce) { html body .cookie-btn { transition: none !important; } } </style> <style> /** * Enhanced modal management with aggressive visibility enforcement * Following MIJUG .NET workspace performance and accessibility standards */ const modalManager = { show() { const modal = getElement(CONFIG.MODAL_ELEMENT_ID); if (!modal) { console.error('❌ Cookie settings modal element not found'); return; } // Load current preferences before showing this.loadCurrentPreferences(); // Use z-index higher than site header but compatible with theme modal.style.cssText = ` display: flex !important; visibility: visible !important; opacity: 1 !important; position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.85) !important; z-index: 1002 !important; align-items: center !important; justify-content: center !important; padding: 1rem !important; box-sizing: border-box !important; `; modal.setAttribute('aria-hidden', 'false'); modal.classList.add('cookie-modal-visible'); // Set up focus management focusManager.trapFocus(modal); // Prevent body scroll when modal is open using existing MIJUG class document.body.classList.add('nav-open'); console.log('✅ Cookie settings modal displayed'); }, hide() { const modal = getElement(CONFIG.MODAL_ELEMENT_ID); if (!modal) return; modal.style.display = 'none'; modal.setAttribute('aria-hidden', 'true'); modal.classList.remove('cookie-modal-visible'); // Remove focus trap if (modal._removeFocusTrap) { modal._removeFocusTrap(); } // Restore body scroll using existing MIJUG class document.body.classList.remove('nav-open'); // Return focus to settings button const settingsButton = getElement('cookie-settings'); if (settingsButton) { settingsButton.focus(); } console.log('✅ Cookie settings modal hidden'); }, loadCurrentPreferences() { const preferences = cookieUtils.get(CONFIG.COOKIE_PREFERENCES_KEY); let analytics = false; let advertising = false; if (preferences) { try { const prefs = JSON.parse(preferences); analytics = prefs.analytics || false; advertising = prefs.advertising || false; } catch (e) { console.warn('⚠️ Error parsing saved preferences:', e); } } // Update checkboxes with retry mechanism setTimeout(() => { const analyticsCheckbox = getElement('analytics-cookies'); const advertisingCheckbox = getElement('advertising-cookies'); if (analyticsCheckbox) { analyticsCheckbox.checked = analytics; } if (advertisingCheckbox) { advertisingCheckbox.checked = advertising; } console.log('📋 Current preferences loaded:', { analytics, advertising }); }, 100); } }; </style> <script> /** * Cookie Consent Management System * Streamlined implementation using MIJUG theme styles * Following MIJUG .NET Workspace coding standards */ (function () { 'use strict'; // Configuration constants following MIJUG naming conventions const CONFIG = { COOKIE_CONSENT_KEY: 'mijug-cookie-consent', COOKIE_PREFERENCES_KEY: 'mijug-cookie-preferences', CONSENT_EXPIRY_DAYS: 365, FOCUS_TRAP_SELECTORS: 'button, [href], input:not([type=hidden]), select, textarea, [tabindex]:not([tabindex="-1"])', BANNER_ELEMENT_ID: 'cookie-consent-banner', MODAL_ELEMENT_ID: 'cookie-settings-modal' }; // Performance-optimized element caching const elementCache = new Map(); /** * Performance-optimized DOM element retrieval with caching * @param {string} id - Element ID * @returns {HTMLElement|null} - Cached or fresh DOM element */ function getElement(id) { if (!elementCache.has(id)) { elementCache.set(id, document.getElementById(id)); } return elementCache.get(id); } /** * Modern cookie utilities with enhanced error handling */ const cookieUtils = { get(name) { try { const cookies = document.cookie.split(';'); for (const cookie of cookies) { const [key, value] = cookie.trim().split('='); if (key === name) { return decodeURIComponent(value); } } return null; } catch (error) { console.warn(`⚠️ Error reading cookie ${name}:`, error); return null; } }, set(name, value, days) { try { const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString(); const cookieString = `${name}=${encodeURIComponent(value)};expires=${expires};path=/;SameSite=Strict`; document.cookie = cookieString; console.log(`🍪 Cookie set: ${name}=${value}`); } catch (error) { console.error(`❌ Error setting cookie ${name}:`, error); } }, clear(name) { try { const clearCookieVariations = [ `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`, `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${window.location.hostname};`, `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.${window.location.hostname};` ]; clearCookieVariations.forEach(cookieString => { document.cookie = cookieString; }); console.log(`🗑️ Cookie cleared: ${name}`); } catch (error) { console.warn(`⚠️ Error clearing cookie ${name}:`, error); } } }; /** * Enhanced banner visibility management using existing theme z-index patterns */ const bannerManager = { show() { const banner = getElement(CONFIG.BANNER_ELEMENT_ID); const modal = getElement(CONFIG.MODAL_ELEMENT_ID); if (!banner) { console.error('❌ Cookie consent banner element not found'); return; } // Use z-index that works with existing MIJUG theme banner.style.cssText = ` display: block !important; visibility: visible !important; opacity: 1 !important; position: fixed !important; bottom: 0 !important; left: 0 !important; right: 0 !important; z-index: 1001 !important; background: #2c3e50 !important; color: white !important; padding: 1rem !important; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3) !important; border-top: 3px solid #3498db !important; min-height: 80px !important; width: 100vw !important; box-sizing: border-box !important; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important; `; banner.setAttribute('aria-hidden', 'false'); banner.classList.add('cookie-banner-visible'); // Ensure modal stays hidden if (modal) { modal.style.display = 'none'; modal.setAttribute('aria-hidden', 'true'); } console.log('✅ Cookie consent banner displayed'); }, hide() { const banner = getElement(CONFIG.BANNER_ELEMENT_ID); if (banner) { banner.style.display = 'none'; banner.setAttribute('aria-hidden', 'true'); banner.classList.remove('cookie-banner-visible'); console.log('✅ Cookie consent banner hidden'); } } }; /** * Enhanced modal management leveraging MIJUG theme patterns */ const modalManager = { show() { const modal = getElement(CONFIG.MODAL_ELEMENT_ID); if (!modal) { console.error('❌ Cookie settings modal element not found'); return; } // Load current preferences before showing this.loadCurrentPreferences(); // Use z-index higher than site header but compatible with theme modal.style.cssText = ` display: flex !important; visibility: visible !important; opacity: 1 !important; position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.85) !important; z-index: 1002 !important; align-items: center !important; justify-content: center !important; padding: 1rem !important; box-sizing: border-box !important; `; modal.setAttribute('aria-hidden', 'false'); modal.classList.add('cookie-modal-visible'); // Set up focus management focusManager.trapFocus(modal); // Prevent body scroll when modal is open using existing MIJUG class document.body.classList.add('nav-open'); console.log('✅ Cookie settings modal displayed'); }, hide() { const modal = getElement(CONFIG.MODAL_ELEMENT_ID); if (!modal) return; modal.style.display = 'none'; modal.setAttribute('aria-hidden', 'true'); modal.classList.remove('cookie-modal-visible'); // Remove focus trap if (modal._removeFocusTrap) { modal._removeFocusTrap(); } // Restore body scroll using existing MIJUG class document.body.classList.remove('nav-open'); // Return focus to settings button const settingsButton = getElement('cookie-settings'); if (settingsButton) { settingsButton.focus(); } console.log('✅ Cookie settings modal hidden'); }, loadCurrentPreferences() { const preferences = cookieUtils.get(CONFIG.COOKIE_PREFERENCES_KEY); let analytics = false; let advertising = false; if (preferences) { try { const prefs = JSON.parse(preferences); analytics = prefs.analytics || false; advertising = prefs.advertising || false; } catch (e) { console.warn('⚠️ Error parsing saved preferences:', e); } } // Update checkboxes with retry mechanism setTimeout(() => { const analyticsCheckbox = getElement('analytics-cookies'); const advertisingCheckbox = getElement('advertising-cookies'); if (analyticsCheckbox) { analyticsCheckbox.checked = analytics; } if (advertisingCheckbox) { advertisingCheckbox.checked = advertising; } console.log('📋 Current preferences loaded:', { analytics, advertising }); }, 100); } }; /** * Consent state management with enhanced logic */ const consentManager = { shouldShowConsent() { try { // Testing override - highest priority if (window.forceShowCookieConsent === true) { console.log('🧪 Testing override: Forcing cookie consent display'); return true; } // URL parameter override const urlParams = new URLSearchParams(window.location.search); if (urlParams.get('force-cookie-consent') === 'true') { console.log('🧪 URL parameter override: Forcing cookie consent display'); return true; } // Development mode detection const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.endsWith('.local'); if (isDevelopment) { console.log('🔧 Development mode detected - showing cookie consent'); return true; } // Check existing consent const consentCookie = cookieUtils.get(CONFIG.COOKIE_CONSENT_KEY); if (consentCookie !== null && consentCookie !== '') { console.log('✅ Existing consent found:', consentCookie); return false; } console.log('📋 No existing consent - showing banner for GDPR compliance'); return true; } catch (error) { console.warn('⚠️ Error checking consent status:', error); return true; } }, hasConsent() { return cookieUtils.get(CONFIG.COOKIE_CONSENT_KEY) !== null; }, hasAnalyticsConsent() { const preferences = cookieUtils.get(CONFIG.COOKIE_PREFERENCES_KEY); if (!preferences) return false; try { return JSON.parse(preferences).analytics === true; } catch { return false; } }, hasAdvertisingConsent() { const preferences = cookieUtils.get(CONFIG.COOKIE_PREFERENCES_KEY); if (!preferences) return false; try { return JSON.parse(preferences).advertising === true; } catch { return false; } } }; /** * Analytics integration with localhost safety */ const analyticsManager = { loadAnalytics() { if (consentManager.hasAnalyticsConsent() && typeof gtag !== 'undefined') { gtag('consent', 'update', { analytics_storage: 'granted' }); console.log('📊 Analytics loaded with user consent'); } else { console.log('📊 Analytics not loaded (no consent or localhost)'); } }, loadAdSense() { if (consentManager.hasAdvertisingConsent() && typeof gtag !== 'undefined') { gtag('consent', 'update', { ad_storage: 'granted', ad_user_data: 'granted', ad_personalization: 'granted', }); console.log('📢 AdSense loaded with user consent'); } else { console.log('📢 AdSense not loaded (no consent or localhost)'); } } }; /** * Focus management for accessibility compliance */ const focusManager = { trapFocus(modal) { const focusableEls = modal.querySelectorAll(CONFIG.FOCUS_TRAP_SELECTORS); const firstFocusableEl = focusableEls[0]; const lastFocusableEl = focusableEls[focusableEls.length - 1]; const handleKeydown = (e) => { if (e.key === 'Tab') { if (e.shiftKey && document.activeElement === firstFocusableEl) { e.preventDefault(); lastFocusableEl?.focus(); } else if (!e.shiftKey && document.activeElement === lastFocusableEl) { e.preventDefault(); firstFocusableEl?.focus(); } } else if (e.key === 'Escape') { closeCookieSettings(); } }; modal.addEventListener('keydown', handleKeydown); modal._removeFocusTrap = () => modal.removeEventListener('keydown', handleKeydown); // Focus close button first for better UX requestAnimationFrame(() => { const closeButton = modal.querySelector('.cookie-modal-close'); if (closeButton) { closeButton.focus(); } else { firstFocusableEl?.focus(); } }); } }; /** * Global button handlers with enhanced error handling */ window.acceptCookies = function () { try { const preferences = { analytics: true, advertising: true }; cookieUtils.set(CONFIG.COOKIE_CONSENT_KEY, 'accepted', CONFIG.CONSENT_EXPIRY_DAYS); cookieUtils.set(CONFIG.COOKIE_PREFERENCES_KEY, JSON.stringify(preferences), CONFIG.CONSENT_EXPIRY_DAYS); bannerManager.hide(); analyticsManager.loadAnalytics(); analyticsManager.loadAdSense(); console.log('✅ All cookies accepted'); } catch (error) { console.error('❌ Error accepting cookies:', error); } }; window.declineCookies = function () { try { const preferences = { analytics: false, advertising: false }; cookieUtils.set(CONFIG.COOKIE_CONSENT_KEY, 'declined', CONFIG.CONSENT_EXPIRY_DAYS); cookieUtils.set(CONFIG.COOKIE_PREFERENCES_KEY, JSON.stringify(preferences), CONFIG.CONSENT_EXPIRY_DAYS); bannerManager.hide(); console.log('❌ Optional cookies declined'); } catch (error) { console.error('❌ Error declining cookies:', error); } }; window.showCookieSettings = function () { try { console.log('🔧 Attempting to show cookie settings modal...'); modalManager.show(); } catch (error) { console.error('❌ Error showing cookie settings:', error); } }; window.closeCookieSettings = function () { try { modalManager.hide(); } catch (error) { console.error('❌ Error closing cookie settings:', error); } }; window.savePreferences = function () { try { const analyticsCheckbox = getElement('analytics-cookies'); const advertisingCheckbox = getElement('advertising-cookies'); const analytics = analyticsCheckbox?.checked || false; const advertising = advertisingCheckbox?.checked || false; const preferences = { analytics, advertising }; cookieUtils.set(CONFIG.COOKIE_CONSENT_KEY, 'customized', CONFIG.CONSENT_EXPIRY_DAYS); cookieUtils.set(CONFIG.COOKIE_PREFERENCES_KEY, JSON.stringify(preferences), CONFIG.CONSENT_EXPIRY_DAYS); bannerManager.hide(); modalManager.hide(); if (analytics) analyticsManager.loadAnalytics(); if (advertising) analyticsManager.loadAdSense(); console.log('💾 Custom preferences saved:', preferences); showSaveConfirmation(); } catch (error) { console.error('❌ Error saving preferences:', error); } }; /** * Save confirmation using MIJUG theme patterns */ function showSaveConfirmation() { const notification = document.createElement('div'); notification.className = 'mijug-highlight favorite-toast favorite-toast-success favorite-toast-visible'; notification.style.cssText = ` position: fixed !important; top: 20px !important; right: 20px !important; z-index: 1003 !important; max-width: 300px !important; padding: 1rem 1.5rem !important; border-radius: 8px !important; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important; animation: slideInRight 0.3s ease-out !important; `; notification.innerHTML = ` <div style="display: flex; align-items: center; gap: 0.5rem;"> <span style="font-size: 1.2rem;">✅</span> <span>Cookie preferences saved successfully!</span> </div> `; notification.setAttribute('role', 'alert'); notification.setAttribute('aria-live', 'polite'); document.body.appendChild(notification); setTimeout(() => { if (notification.parentNode) { notification.parentNode.removeChild(notification); } }, 4000); } /** * Enhanced initialization with multiple retry strategies */ function initialize() { console.log('🚀 Cookie consent system initializing...'); // Ensure modal is hidden on initialization const modal = getElement(CONFIG.MODAL_ELEMENT_ID); if (modal) { modal.style.display = 'none'; modal.setAttribute('aria-hidden', 'true'); } if (consentManager.shouldShowConsent()) { bannerManager.show(); // Retry mechanisms for theme compatibility setTimeout(() => bannerManager.show(), 100); setTimeout(() => bannerManager.show(), 500); } else if (consentManager.hasConsent()) { analyticsManager.loadAnalytics(); analyticsManager.loadAdSense(); } } /** * Testing mode with enhanced visibility enforcement */ function initializeTestingMode() { console.log('🧪 TESTING MODE: Enhanced cookie consent forcing'); // Clear existing cookies const cookiesToClear = [CONFIG.COOKIE_CONSENT_KEY, CONFIG.COOKIE_PREFERENCES_KEY]; cookiesToClear.forEach(cookieName => cookieUtils.clear(cookieName)); // Set testing flags window.forceShowCookieConsent = true; setTimeout(() => { bannerManager.show(); console.log('🧪 Testing banner display forced'); }, 50); // Disable testing mode after timeout setTimeout(() => { window.forceShowCookieConsent = false; console.log('🧪 Testing mode disabled'); }, 30000); } // Event listeners document.addEventListener('DOMContentLoaded', () => { try { initialize(); if (window.location.search.includes('force-cookie-consent=true') || window.location.hostname === 'localhost') { initializeTestingMode(); } } catch (error) { console.error('❌ Error during cookie consent initialization:', error); } }); // Modal click-outside handler document.addEventListener('click', (event) => { const modal = getElement(CONFIG.MODAL_ELEMENT_ID); if (modal && event.target === modal) { closeCookieSettings(); } }); })(); </script> </body> </html>
